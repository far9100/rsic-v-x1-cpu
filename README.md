# RISC-V 32I CPU å¯¦ç¾

é€™æ˜¯ä¸€å€‹åŸºæ–¼ Verilog çš„ RISC-V 32I CPU å¯¦ç¾ï¼Œæ¡ç”¨äº”ç´šç®¡ç·šæ¶æ§‹ã€‚

## å°ˆæ¡ˆçµæ§‹

```
rsic-v-x1-cpu/
â”œâ”€â”€ assembler/               # çµ„è­¯å™¨
â”‚   â”œâ”€â”€ assembler.py        # Python çµ„è­¯å™¨
â”‚   â””â”€â”€ instructions.py     # æŒ‡ä»¤å®šç¾©
â”œâ”€â”€ hardware/               # ç¡¬é«”è¨­è¨ˆ
â”‚   â”œâ”€â”€ rtl/               # RTL æª”æ¡ˆ
â”‚   â”‚   â”œâ”€â”€ cpu_top.v      # CPU é ‚å±¤æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ if_stage.v     # IF éšæ®µ
â”‚   â”‚   â”œâ”€â”€ id_stage.v     # ID éšæ®µ
â”‚   â”‚   â”œâ”€â”€ ex_stage.v     # EX éšæ®µ
â”‚   â”‚   â”œâ”€â”€ mem_stage.v    # MEM éšæ®µ
â”‚   â”‚   â”œâ”€â”€ alu.v          # ALU
â”‚   â”‚   â”œâ”€â”€ branch_unit.v  # åˆ†æ”¯å–®å…ƒ
â”‚   â”‚   â”œâ”€â”€ reg_file.v     # æš«å­˜å™¨æª”æ¡ˆ
â”‚   â”‚   â”œâ”€â”€ control_unit.v # æ§åˆ¶å–®å…ƒ
â”‚   â”‚   â”œâ”€â”€ forwarding_unit.v # å‰éå–®å…ƒ
â”‚   â”‚   â”œâ”€â”€ hazard_detection_unit.v # å±éšªæª¢æ¸¬å–®å…ƒ
â”‚   â”‚   â”œâ”€â”€ immediate_generator.v # ç«‹å³æ•¸ç”¢ç”Ÿå™¨
â”‚   â”‚   â”œâ”€â”€ multiplier.v   # ä¹˜æ³•å™¨
â”‚   â”‚   â””â”€â”€ pipeline_reg_*.v # ç®¡ç·šæš«å­˜å™¨
â”‚   â””â”€â”€ sim/               # æ¨¡æ“¬æª”æ¡ˆ
â”‚       â”œâ”€â”€ tb_branch_test.v # åˆ†æ”¯æ¸¬è©¦ testbench
â”‚       â”œâ”€â”€ tb_alu_test.v   # ALU æ¸¬è©¦ testbench
â”‚       â”œâ”€â”€ tb_load_store_test.v # è¼‰å…¥/å„²å­˜æ¸¬è©¦ testbench
â”‚       â””â”€â”€ tb_simple_test.v # ç°¡å–®æ¸¬è©¦ testbench
â””â”€â”€ tests/                 # æ¸¬è©¦ç¨‹å¼
    â”œâ”€â”€ asm_sources/       # çµ„èªåŸå§‹æª”
    â””â”€â”€ hex_outputs/       # çµ„è­¯å¾Œçš„æ©Ÿå™¨ç¢¼
```

## CPU ç‰¹æ€§

- **æ¶æ§‹**: RISC-V 32I åŸºç¤æ•´æ•¸æŒ‡ä»¤é›†
- **ç®¡ç·š**: äº”ç´šç®¡ç·š (IF, ID, EX, MEM, WB)
- **æš«å­˜å™¨**: 32å€‹ 32-bit é€šç”¨æš«å­˜å™¨
- **è¨˜æ†¶é«”**: åˆ†é›¢å¼æŒ‡ä»¤å’Œè³‡æ–™è¨˜æ†¶é«”
- **å‰é**: æ”¯æ´è³‡æ–™å‰éé¿å…éƒ¨åˆ†å±éšª
- **å±éšªæª¢æ¸¬**: å®Œæ•´çš„å±éšªæª¢æ¸¬å–®å…ƒ
- **åˆ†æ”¯**: æ”¯æ´æ‰€æœ‰ RISC-V åˆ†æ”¯æŒ‡ä»¤
- **ä¹˜æ³•**: æ”¯æ´ä¹˜æ³•é‹ç®—

## æ”¯æ´çš„æŒ‡ä»¤

### ç®—è¡“æŒ‡ä»¤
- `ADD`, `SUB`, `ADDI`
- `AND`, `OR`, `XOR`, `ANDI`, `ORI`, `XORI`
- `SLL`, `SRL`, `SRA`, `SLLI`, `SRLI`, `SRAI`
- `SLT`, `SLTU`, `SLTI`, `SLTIU`

### è¨˜æ†¶é«”æŒ‡ä»¤
- `LW`, `LH`, `LB`, `LHU`, `LBU`
- `SW`, `SH`, `SB`

### åˆ†æ”¯æŒ‡ä»¤
- `BEQ`, `BNE`, `BLT`, `BGE`, `BLTU`, `BGEU`
- `JAL`, `JALR`

### å…¶ä»–æŒ‡ä»¤
- `LUI`, `AUIPC`

## æ¸¬è©¦

### 1. åŠ æ³•æ¸¬è©¦
```bash
# çµ„è­¯æ¸¬è©¦ç¨‹å¼
python assembler/assembler.py ./tests/asm_sources/add_integrated_test.asm -o ./tests/hex_outputs/add_integrated_test.hex

# ç·¨è­¯ Verilog
iverilog -o add_sim hardware/sim/tb_simple_test.v hardware/rtl/*.v

# åŸ·è¡Œæ¨¡æ“¬
vvp add_sim
```

**åŠ æ³•æ¸¬è©¦å…§å®¹:**
- ADD æŒ‡ä»¤æ¸¬è©¦
- ADDI æŒ‡ä»¤æ¸¬è©¦
- æ­£æ•¸åŠ æ³•
- è² æ•¸åŠ æ³•
- æº¢ä½æƒ…æ³

### 2. ä¹˜æ³•æ¸¬è©¦
```bash
# çµ„è­¯æ¸¬è©¦ç¨‹å¼
python assembler/assembler.py ./tests/asm_sources/mul_integrated_test.asm -o ./tests/hex_outputs/mul_integrated_test.hex

# ç·¨è­¯ Verilog
iverilog -o mul_sim hardware/sim/tb_simple_test.v hardware/rtl/*.v

# åŸ·è¡Œæ¨¡æ“¬
vvp mul_sim
```

**ä¹˜æ³•æ¸¬è©¦å…§å®¹:**
- MUL æŒ‡ä»¤æ¸¬è©¦
- æ­£æ•¸ä¹˜æ³•
- è² æ•¸ä¹˜æ³•
- å¤§æ•¸ä¹˜æ³•

### 3. åˆ†æ”¯æ¸¬è©¦ âœ…
```bash
# çµ„è­¯æ¸¬è©¦ç¨‹å¼
python assembler/assembler.py ./tests/asm_sources/branch_integrated_test.asm -o ./tests/hex_outputs/branch_integrated_test.hex

# ç·¨è­¯ Verilog
iverilog -o branch_sim hardware/sim/tb_branch_test.v hardware/rtl/*.v

# åŸ·è¡Œæ¨¡æ“¬
vvp branch_sim
```

**åˆ†æ”¯æ¸¬è©¦å…§å®¹:**
- âœ… BEQ (ç›¸ç­‰åˆ†æ”¯)
- âœ… BNE (ä¸ç­‰åˆ†æ”¯)  
- âœ… BLT (å°æ–¼åˆ†æ”¯, æœ‰ç¬¦è™Ÿ)
- âœ… BGE (å¤§æ–¼ç­‰æ–¼åˆ†æ”¯, æœ‰ç¬¦è™Ÿ)
- âœ… BLTU (å°æ–¼åˆ†æ”¯, ç„¡ç¬¦è™Ÿ)
- âœ… BGEU (å¤§æ–¼ç­‰æ–¼åˆ†æ”¯, ç„¡ç¬¦è™Ÿ)
- âœ… è² æ•¸æ¯”è¼ƒæ¸¬è©¦
- âœ… é›¶å€¼æ¯”è¼ƒæ¸¬è©¦
- âœ… åˆ†æ”¯ä¸æ¡ç”¨æƒ…æ³
- âœ… ç°¡åŒ–å‘å‰è·³è½‰è¿´åœˆ
- âœ… çœŸå¯¦å‘å¾Œè·³è½‰è¿´åœˆ (ä½¿ç”¨è² æ•¸ç«‹å³æ•¸)
- âœ… LUIæŒ‡ä»¤æ”¯æ´ - å¯¦ç¾Load Upper ImmediateæŒ‡ä»¤ âœ…

## æ¸¬è©¦ç‹€æ…‹

| æ¸¬è©¦é …ç›® | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|
| åŠ æ³•æ¸¬è©¦ | âœ… é€šé | ADD å’Œ ADDI æŒ‡ä»¤é‹ç®—æ­£å¸¸ |
| ä¹˜æ³•æ¸¬è©¦ | âœ… é€šé | MUL æŒ‡ä»¤é‹ç®—æ­£å¸¸ |
| åˆ†æ”¯æ¸¬è©¦ | âœ… é€šé | æ‰€æœ‰åˆ†æ”¯æŒ‡ä»¤å’Œè·³è½‰æ­£å¸¸ |

## æœ€è¿‘ä¿®æ­£çš„å•é¡Œ

### åˆ†æ”¯æ¸¬è©¦ä¿®æ­£ (å·²å®Œæˆ)
1. **ç„¡é™è¿´åœˆå•é¡Œ**: ä¿®æ­£äº†ç®¡ç·šæ§åˆ¶é‚è¼¯ï¼Œæ·»åŠ äº†æ­£ç¢ºçš„ç®¡ç·šæ²–æ´—æ©Ÿåˆ¶
2. **å±éšªæª¢æ¸¬**: å¯¦ç¾äº†å®Œæ•´çš„å±éšªæª¢æ¸¬å–®å…ƒï¼ŒåŒ…å«è¼‰å…¥-ä½¿ç”¨å±éšªæª¢æ¸¬
3. **åˆ†æ”¯æ§åˆ¶**: æ·»åŠ äº† `pc_write_en`, `if_id_write_en`, `if_id_flush_en`, `id_ex_flush_en` æ§åˆ¶ä¿¡è™Ÿ
4. **ä¿¡è™Ÿé€£æ¥**: ä¿®æ­£äº† `d_mem_wdata` çš„é‡è¤‡é€£æ¥å•é¡Œ
5. **æ¸¬è©¦ç¨‹å¼**: ç°¡åŒ–äº†è¿´åœˆæ¸¬è©¦é‚è¼¯ï¼Œé¿å…ç„¡é™è¿´åœˆå•é¡Œ
6. **ä¹˜æ³•æ”¯æ´**: æ·»åŠ äº†ä¹˜æ³•å™¨æ¨¡çµ„ï¼Œæ”¯æ´ä¹˜æ³•é‹ç®—

## é–‹ç™¼å·¥å…·

- **æ¨¡æ“¬å™¨**: Icarus Verilog
- **çµ„è­¯å™¨**: è‡ªè£½ Python çµ„è­¯å™¨
- **æ¸¬è©¦**: è‡ªè£½ testbench

## ä½¿ç”¨æ–¹æ³•

1. ç¢ºä¿å®‰è£äº† Icarus Verilog å’Œ Python
2. å°‡çµ„èªç¨‹å¼æ”¾åœ¨ `tests/asm_sources/` ç›®éŒ„
3. ä½¿ç”¨çµ„è­¯å™¨å°‡çµ„èªè½‰æ›ç‚ºæ©Ÿå™¨ç¢¼
4. åŸ·è¡Œå°æ‡‰çš„ testbench é€²è¡Œæ¨¡æ“¬

## æ³¨æ„äº‹é …

- ç›®å‰å¯¦ç¾ç‚ºæ•™è‚²ç”¨é€”ï¼Œä¸åŒ…å«æ‰€æœ‰ RISC-V ç‰¹æ€§
- è¨˜æ†¶é«”ç³»çµ±ç‚ºç°¡åŒ–ç‰ˆæœ¬
- ç®¡ç·šæ§åˆ¶é‚è¼¯é‡å°åŸºæœ¬æƒ…æ³è¨­è¨ˆ
- åˆ†æ”¯é æ¸¬åŠŸèƒ½å°šæœªå¯¦ç¾

## åˆ†æ”¯æ¸¬è©¦é …ç›®

### å·²å®Œæˆçš„æ¸¬è©¦é …ç›® âœ…
1. **BEQ (Branch if Equal)** - ç›¸ç­‰åˆ†æ”¯
2. **BNE (Branch if Not Equal)** - ä¸ç›¸ç­‰åˆ†æ”¯  
3. **BLT (Branch if Less Than, signed)** - æœ‰ç¬¦è™Ÿå°æ–¼åˆ†æ”¯
4. **BGE (Branch if Greater or Equal, signed)** - æœ‰ç¬¦è™Ÿå¤§æ–¼ç­‰æ–¼åˆ†æ”¯
5. **BLTU (Branch if Less Than, unsigned)** - ç„¡ç¬¦è™Ÿå°æ–¼åˆ†æ”¯
6. **BGEU (Branch if Greater or Equal, unsigned)** - ç„¡ç¬¦è™Ÿå¤§æ–¼ç­‰æ–¼åˆ†æ”¯
7. **è² æ•¸æ¯”è¼ƒæ¸¬è©¦** - æ¸¬è©¦è² æ•¸çš„åˆ†æ”¯è¡Œç‚º
8. **åˆ†æ”¯ä¸æ¡ç”¨æ¸¬è©¦** - æ¸¬è©¦æ¢ä»¶ä¸æ»¿è¶³æ™‚çš„è¡Œç‚º
9. **é›¶å€¼æ¯”è¼ƒæ¸¬è©¦** - æ¸¬è©¦èˆ‡é›¶å€¼çš„æ¯”è¼ƒ
10. **ç°¡åŒ–è¿´åœˆæ¸¬è©¦** - æ¸¬è©¦å‘å‰è·³è½‰çš„è¿´åœˆ
11. **çœŸå¯¦è¿´åœˆæ¸¬è©¦** - æ¸¬è©¦å‘å¾Œè·³è½‰çš„è¿´åœˆï¼ˆä½¿ç”¨è² æ•¸ç«‹å³æ•¸ï¼‰
12. **LUIæŒ‡ä»¤æ”¯æ´** - å¯¦ç¾Load Upper ImmediateæŒ‡ä»¤ âœ…

### å·²å®Œæˆçš„æ¸¬è©¦é …ç›® âœ… (çºŒ)
13. **æœ‰ç¬¦è™Ÿvsç„¡ç¬¦è™Ÿå·®ç•°æ¸¬è©¦** - ä½¿ç”¨LUIæŒ‡ä»¤ç”¢ç”Ÿ0x80000000æ¸¬è©¦æœ‰ç¬¦è™Ÿ/ç„¡ç¬¦è™Ÿæ¯”è¼ƒå·®ç•° âœ…

### å¾…å®Œæˆçš„æ¸¬è©¦é …ç›® ğŸ”„
1. **JAL (Jump and Link)** - è·³è½‰ä¸¦é€£çµæŒ‡ä»¤
2. **JALR (Jump and Link Register)** - æš«å­˜å™¨è·³è½‰ä¸¦é€£çµæŒ‡ä»¤ï¼ˆéœ€è¦AUIPCï¼‰

### LUIæŒ‡ä»¤å¯¦ç¾è©³æƒ… âœ…
- **çµ„è­¯å™¨æ”¯æ´**ï¼šå·²å¯¦ç¾Uå‹æŒ‡ä»¤çµ„è­¯å‡½æ•¸
- **ç¡¬é«”æ”¯æ´**ï¼š
  - æ§åˆ¶å–®å…ƒæ­£ç¢ºè­˜åˆ¥LUI opcode (0110111)
  - ç«‹å³å€¼ç”¢ç”Ÿå™¨æ­£ç¢ºè™•ç†Uå‹ç«‹å³å€¼
  - IDéšæ®µå¼·åˆ¶LUIæŒ‡ä»¤çš„rs1ç‚ºx0æš«å­˜å™¨
  - ALUåŸ·è¡Œ `0 + ç«‹å³å€¼` é‹ç®—
- **æ¸¬è©¦é©—è­‰**ï¼šé€šéå°ˆé–€çš„LUIæ¸¬è©¦ï¼Œæ­£ç¢ºè¼‰å…¥0x80000000å’Œ0x12345000

### æœ‰ç¬¦è™Ÿvsç„¡ç¬¦è™Ÿå·®ç•°æ¸¬è©¦è©³æƒ… âœ…
- **æ¸¬è©¦å€¼**ï¼šä½¿ç”¨ `lui x20, 0x80000` è¼‰å…¥ `0x80000000`
- **æœ‰ç¬¦è™Ÿè§£é‡‹**ï¼š`0x80000000` = `-2147483648` (æœ€å°è² æ•¸)
- **ç„¡ç¬¦è™Ÿè§£é‡‹**ï¼š`0x80000000` = `2147483648` (å¤§æ­£æ•¸)
- **æ¸¬è©¦æ¡ˆä¾‹**ï¼š
  1. `blt 0x80000000, 0` (æœ‰ç¬¦è™Ÿ) â†’ True âœ… (è² æ•¸ < 0)
  2. `bltu 0x80000000, 0` (ç„¡ç¬¦è™Ÿ) â†’ False âœ… (å¤§æ­£æ•¸ > 0)
  3. `bge 0, 0x80000000` (æœ‰ç¬¦è™Ÿ) â†’ True âœ… (0 > è² æ•¸)
  4. `bgeu 0, 0x80000000` (ç„¡ç¬¦è™Ÿ) â†’ False âœ… (0 < å¤§æ­£æ•¸)
- **çµæœ**ï¼šæ‰€æœ‰æ¸¬è©¦æ­£ç¢ºé€šéï¼Œè­‰æ˜åˆ†æ”¯å–®å…ƒæ­£ç¢ºå¯¦ç¾æœ‰ç¬¦è™Ÿ/ç„¡ç¬¦è™Ÿæ¯”è¼ƒ

### æ¸¬è©¦åŸ·è¡Œæ–¹æ³•
