# RISC-V 32I CPU å¯¦ç¾

é€™æ˜¯ä¸€å€‹åŸºæ–¼ Verilog çš„ RISC-V 32I CPU å¯¦ç¾ï¼Œæ¡ç”¨äº”ç´šç®¡ç·šæ¶æ§‹ã€‚

## å°ˆæ¡ˆçµæ§‹

```
rsic-v-x1-cpu/
â”œâ”€â”€ assembler/               # çµ„è­¯å™¨
â”‚   â”œâ”€â”€ assembler.py        # Python çµ„è­¯å™¨
â”‚   â””â”€â”€ instructions.py     # æŒ‡ä»¤å®šç¾©
â”œâ”€â”€ hardware/               # ç¡¬é«”è¨­è¨ˆ
â”‚   â”œâ”€â”€ rtl/               # RTL æª”æ¡ˆ
â”‚   â”‚   â”œâ”€â”€ cpu_top.v      # CPU é ‚å±¤æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ if_stage.v     # IF éšæ®µ
â”‚   â”‚   â”œâ”€â”€ id_stage.v     # ID éšæ®µ
â”‚   â”‚   â”œâ”€â”€ ex_stage.v     # EX éšæ®µ
â”‚   â”‚   â”œâ”€â”€ mem_stage.v    # MEM éšæ®µ
â”‚   â”‚   â”œâ”€â”€ alu.v          # ALU
â”‚   â”‚   â”œâ”€â”€ branch_unit.v  # åˆ†æ”¯å–®å…ƒ
â”‚   â”‚   â”œâ”€â”€ reg_file.v     # æš«å­˜å™¨æª”æ¡ˆ
â”‚   â”‚   â”œâ”€â”€ control_unit.v # æ§åˆ¶å–®å…ƒ
â”‚   â”‚   â”œâ”€â”€ forwarding_unit.v # å‰éå–®å…ƒ
â”‚   â”‚   â”œâ”€â”€ hazard_detection_unit.v # å±éšªæª¢æ¸¬å–®å…ƒ
â”‚   â”‚   â”œâ”€â”€ immediate_generator.v # ç«‹å³æ•¸ç”¢ç”Ÿå™¨
â”‚   â”‚   â”œâ”€â”€ multiplier.v   # ä¹˜æ³•å™¨
â”‚   â”‚   â””â”€â”€ pipeline_reg_*.v # ç®¡ç·šæš«å­˜å™¨
â”‚   â””â”€â”€ sim/               # æ¨¡æ“¬æª”æ¡ˆ
â”‚       â”œâ”€â”€ tb_branch_test.v # åˆ†æ”¯æ¸¬è©¦ testbench
â”‚       â”œâ”€â”€ tb_simple_jal_test.v # JALæ¸¬è©¦ testbench
â”‚       â”œâ”€â”€ tb_add_test.v   # åŠ æ³•æ¸¬è©¦ testbench
â”‚       â””â”€â”€ tb_mul_test.v   # ä¹˜æ³•æ¸¬è©¦ testbench
â””â”€â”€ tests/                 # æ¸¬è©¦ç¨‹å¼
    â”œâ”€â”€ asm_sources/       # çµ„èªåŸå§‹æª”
    â”‚   â”œâ”€â”€ add_integrated_test.asm     # åŠ æ³•æ¸¬è©¦
    â”‚   â”œâ”€â”€ mul_integrated_test.asm     # ä¹˜æ³•æ¸¬è©¦
    â”‚   â”œâ”€â”€ branch_integrated_test.asm  # åˆ†æ”¯æ¸¬è©¦ï¼ˆåŒ…å«LUIï¼‰
    â”‚   â””â”€â”€ simple_jal_test.asm        # JALæ¸¬è©¦
    â””â”€â”€ hex_outputs/       # çµ„è­¯å¾Œçš„æ©Ÿå™¨ç¢¼
```

## CPU ç‰¹æ€§

- **æ¶æ§‹**: RISC-V 32I åŸºç¤æ•´æ•¸æŒ‡ä»¤é›†
- **ç®¡ç·š**: äº”ç´šç®¡ç·š (IF, ID, EX, MEM, WB)
- **æš«å­˜å™¨**: 32å€‹ 32-bit é€šç”¨æš«å­˜å™¨
- **è¨˜æ†¶é«”**: åˆ†é›¢å¼æŒ‡ä»¤å’Œè³‡æ–™è¨˜æ†¶é«”
- **å‰é**: æ”¯æ´è³‡æ–™å‰éé¿å…éƒ¨åˆ†å±éšª
- **å±éšªæª¢æ¸¬**: å®Œæ•´çš„å±éšªæª¢æ¸¬å–®å…ƒ
- **åˆ†æ”¯**: æ”¯æ´æ‰€æœ‰ RISC-V åˆ†æ”¯æŒ‡ä»¤
- **ä¹˜æ³•**: æ”¯æ´ä¹˜æ³•é‹ç®—

## æ”¯æ´çš„æŒ‡ä»¤

### ç®—è¡“æŒ‡ä»¤
- `ADD`, `SUB`, `ADDI`
- `AND`, `OR`, `XOR`, `ANDI`, `ORI`, `XORI`
- `SLL`, `SRL`, `SRA`, `SLLI`, `SRLI`, `SRAI`
- `SLT`, `SLTU`, `SLTI`, `SLTIU`

### è¨˜æ†¶é«”æŒ‡ä»¤
- `LW`, `LH`, `LB`, `LHU`, `LBU`
- `SW`, `SH`, `SB`

### åˆ†æ”¯æŒ‡ä»¤
- `BEQ`, `BNE`, `BLT`, `BGE`, `BLTU`, `BGEU`
- `JAL`, `JALR`

### å…¶ä»–æŒ‡ä»¤
- `LUI`, `AUIPC`

## æ¸¬è©¦

### 1. åŠ æ³•æ¸¬è©¦
```bash
# çµ„è­¯æ¸¬è©¦ç¨‹å¼
python assembler/assembler.py ./tests/asm_sources/add_integrated_test.asm -o ./tests/hex_outputs/add_integrated_test.hex

# ç·¨è­¯ Verilog
iverilog -o add_sim hardware/sim/tb_add_test.v hardware/rtl/*.v

# åŸ·è¡Œæ¨¡æ“¬
vvp add_sim
```

**åŠ æ³•æ¸¬è©¦å…§å®¹:**
- ADD æŒ‡ä»¤æ¸¬è©¦
- ADDI æŒ‡ä»¤æ¸¬è©¦
- æ­£æ•¸åŠ æ³•
- è² æ•¸åŠ æ³•
- æº¢ä½æƒ…æ³

### 2. ä¹˜æ³•æ¸¬è©¦
```bash
# çµ„è­¯æ¸¬è©¦ç¨‹å¼
python assembler/assembler.py ./tests/asm_sources/mul_integrated_test.asm -o ./tests/hex_outputs/mul_integrated_test.hex

# ç·¨è­¯ Verilog
iverilog -o mul_sim hardware/sim/tb_mul_test.v hardware/rtl/*.v

# åŸ·è¡Œæ¨¡æ“¬
vvp mul_sim
```

**ä¹˜æ³•æ¸¬è©¦å…§å®¹:**
- MUL æŒ‡ä»¤æ¸¬è©¦
- æ­£æ•¸ä¹˜æ³•
- è² æ•¸ä¹˜æ³•
- å¤§æ•¸ä¹˜æ³•

### 3. åˆ†æ”¯æ¸¬è©¦ âœ…
```bash
# çµ„è­¯æ¸¬è©¦ç¨‹å¼
python assembler/assembler.py ./tests/asm_sources/branch_integrated_test.asm -o ./tests/hex_outputs/branch_integrated_test.hex

# ç·¨è­¯ Verilog
iverilog -o branch_sim hardware/sim/tb_branch_test.v hardware/rtl/*.v

# åŸ·è¡Œæ¨¡æ“¬
vvp branch_sim
```

**åˆ†æ”¯æ¸¬è©¦å…§å®¹:**
- âœ… BEQ (ç›¸ç­‰åˆ†æ”¯)
- âœ… BNE (ä¸ç­‰åˆ†æ”¯)  
- âœ… BLT (å°æ–¼åˆ†æ”¯, æœ‰ç¬¦è™Ÿ)
- âœ… BGE (å¤§æ–¼ç­‰æ–¼åˆ†æ”¯, æœ‰ç¬¦è™Ÿ)
- âœ… BLTU (å°æ–¼åˆ†æ”¯, ç„¡ç¬¦è™Ÿ)
- âœ… BGEU (å¤§æ–¼ç­‰æ–¼åˆ†æ”¯, ç„¡ç¬¦è™Ÿ)
- âœ… è² æ•¸æ¯”è¼ƒæ¸¬è©¦
- âœ… é›¶å€¼æ¯”è¼ƒæ¸¬è©¦
- âœ… åˆ†æ”¯ä¸æ¡ç”¨æƒ…æ³
- âœ… ç°¡åŒ–å‘å‰è·³è½‰è¿´åœˆ
- âœ… çœŸå¯¦å‘å¾Œè·³è½‰è¿´åœˆ (ä½¿ç”¨è² æ•¸ç«‹å³æ•¸)
- âœ… LUIæŒ‡ä»¤æ”¯æ´ - å¯¦ç¾Load Upper ImmediateæŒ‡ä»¤ âœ…

### 4. JALæ¸¬è©¦ âœ… (ç¨ç«‹æ¸¬è©¦)
```bash
# çµ„è­¯æ¸¬è©¦ç¨‹å¼
python assembler/assembler.py tests/asm_sources/simple_jal_test.asm -o tests/hex_outputs/simple_jal_test.hex

# ç·¨è­¯ Verilog
iverilog -o simple_jal_sim -I hardware/rtl hardware/sim/tb_simple_jal_test.v hardware/rtl/*.v

# åŸ·è¡Œæ¨¡æ“¬
vvp simple_jal_sim
```

**JALæ¸¬è©¦å…§å®¹:**
- âœ… JAL (è·³è½‰ä¸¦é€£çµ) - ç¨ç«‹æ¸¬è©¦ç’°å¢ƒ
- âœ… JALR (æš«å­˜å™¨è·³è½‰ä¸¦é€£çµ) - ç¨ç«‹æ¸¬è©¦ç’°å¢ƒ
- âœ… è¿”å›åœ°å€æ­£ç¢ºä¿å­˜ (x7 = 0x00000008)
- âœ… è·³è½‰ç›®æ¨™åœ°å€æ­£ç¢ºè¨ˆç®—
- âœ… æœ€çµ‚çµæœé©—è­‰ (x6 = 20)

### å°šæœªå®Œæˆçš„æ¸¬è©¦ ğŸš§
| æ¸¬è©¦é …ç›® | å„ªå…ˆç´š | èªªæ˜ |
|---------|--------|------|
| åˆ†æ”¯æ¸¬è©¦ä¸­çš„JALæ•´åˆ | é«˜ | JAL (Jump and Link) æŒ‡ä»¤åœ¨åˆ†æ”¯æ¸¬è©¦ä¸­è¢«è¨»è§£ï¼Œéœ€è¦æ•´åˆåˆ°åˆ†æ”¯æ¸¬è©¦æµç¨‹ |
| åˆ†æ”¯æ¸¬è©¦ä¸­çš„JALRæ•´åˆ | é«˜ | JALR (Jump and Link Register) æŒ‡ä»¤åœ¨åˆ†æ”¯æ¸¬è©¦ä¸­è¢«è¨»è§£ï¼Œéœ€è¦æ•´åˆåˆ°åˆ†æ”¯æ¸¬è©¦æµç¨‹ |
| è¨˜æ†¶é«”æ¸¬è©¦ | é«˜ | å°šæœªå¯¦ç¾ LW/LH/LB/LHU/LBU å’Œ SW/SH/SB æŒ‡ä»¤çš„å®Œæ•´æ¸¬è©¦ |?
| ä¸­æ–·è™•ç† | ä¸­ | å°šæœªå¯¦ç¾ä¸­æ–·å’Œç•°å¸¸è™•ç†æ©Ÿåˆ¶ |?
| æ•ˆèƒ½æ¸¬è©¦ | ä½ | å°šæœªé€²è¡Œç®¡ç·šæ•ˆèƒ½å’Œååé‡æ¸¬è©¦ |?
| é‚Šç•Œæ¸¬è©¦ | ä¸­ | å°šæœªé€²è¡Œæ¥µç«¯æƒ…æ³å’Œé‚Šç•Œæ¢ä»¶æ¸¬è©¦ |?

## å·²çŸ¥å•é¡Œ âš ï¸
- JAL/JALRæŒ‡ä»¤æœªèƒ½æ•´åˆè‡³åˆ†æ”¯æ¸¬è©¦
- è² æ•¸ç«‹å³æ•¸æ¸¬è©¦éƒ¨åˆ†ç–‘ä¼¼æœ‰ bug å°šæœªè§£æ±º

| å•é¡Œæè¿° | åš´é‡ç¨‹åº¦ | å½±éŸ¿ç¯„åœ | è§£æ±ºæ–¹æ¡ˆ |
|---------|----------|----------|----------|
| JAL/JALRæŒ‡ä»¤æœªæ•´åˆåˆ°åˆ†æ”¯æ¸¬è©¦ | ä¸­ | åˆ†æ”¯æ¸¬è©¦å®Œæ•´æ€§ | éœ€è¦å°‡è¨»è§£çš„JAL/JALRæ¸¬è©¦é‡æ–°æ•´åˆåˆ°åˆ†æ”¯æ¸¬è©¦æµç¨‹ä¸­ |
| å‰éå–®å…ƒæœªè™•ç†åˆ†æ”¯æŒ‡ä»¤ | é«˜ | åˆ†æ”¯æ¸¬è©¦ | éœ€è¦ä¿®æ”¹å‰éå–®å…ƒï¼Œå¢åŠ å°åˆ†æ”¯æŒ‡ä»¤çš„æ”¯æ´ |
| è¨˜æ†¶é«”å­˜å–æœªå°é½Š | ä¸­ | è¨˜æ†¶é«”æ“ä½œ | éœ€è¦å¯¦ç¾è¨˜æ†¶é«”å°é½Šæª¢æŸ¥å’Œè™•ç† |
| ç¼ºå°‘é™¤éŒ¯ä»‹é¢ | ä½ | é–‹ç™¼æ•ˆç‡ | éœ€è¦æ·»åŠ é™¤éŒ¯ä»‹é¢ï¼Œæ–¹ä¾¿å•é¡Œè¨ºæ–· |
| ç¼ºå°‘æ™‚åºç´„æŸ | ä¸­ | æ™‚åºåˆ†æ | éœ€è¦æ·»åŠ æ™‚åºç´„æŸæª”æ¡ˆ |

## é–‹ç™¼å·¥å…·

- **æ¨¡æ“¬å™¨**: Icarus Verilog
- **çµ„è­¯å™¨**: è‡ªè£½ Python çµ„è­¯å™¨
- **æ¸¬è©¦**: è‡ªè£½ testbench

## ä½¿ç”¨æ–¹æ³•

1. ç¢ºä¿å®‰è£äº† Icarus Verilog å’Œ Python
2. å°‡çµ„èªç¨‹å¼æ”¾åœ¨ `tests/asm_sources/` ç›®éŒ„
3. ä½¿ç”¨çµ„è­¯å™¨å°‡çµ„èªè½‰æ›ç‚ºæ©Ÿå™¨ç¢¼
4. åŸ·è¡Œå°æ‡‰çš„ testbench é€²è¡Œæ¨¡æ“¬

## æ³¨æ„äº‹é …

- ç›®å‰å¯¦ç¾ç‚ºæ•™è‚²ç”¨é€”ï¼Œä¸åŒ…å«æ‰€æœ‰ RISC-V ç‰¹æ€§
- è¨˜æ†¶é«”ç³»çµ±ç‚ºç°¡åŒ–ç‰ˆæœ¬
- ç®¡ç·šæ§åˆ¶é‚è¼¯é‡å°åŸºæœ¬æƒ…æ³è¨­è¨ˆ
